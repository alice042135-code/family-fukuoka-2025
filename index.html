<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>ç¦å²¡å®¶æ—æ—…éŠè¡Œç¨‹ App</title>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover"
    />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['-apple-system', 'BlinkMacSystemFont', 'system-ui', 'sans-serif'],
            },
          },
        },
      };
    </script>

    <style>
      body {
        -webkit-font-smoothing: antialiased;
        background: #f2f2f2;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .sheet-enter-active,
      .sheet-leave-active {
        transition: all 0.2s ease-out;
      }
      .sheet-enter-from,
      .sheet-leave-to {
        opacity: 0;
        transform: translateY(40px);
      }
    </style>
  </head>
  <body class="min-h-screen flex items-center justify-center px-3 py-4">
    <div id="app" class="w-full max-w-md h-[720px] sm:h-[780px]">
      <div
        class="relative flex flex-col w-full h-full rounded-3xl bg-[#f3f3f3] border border-gray-300 shadow-xl overflow-hidden"
      >
        <!-- Header / ç‹€æ…‹åˆ— -->
        <div
          class="h-10 flex items-center justify-between px-4 text-[11px] text-gray-600 border-b border-gray-200 bg-white"
        >
          <span class="font-semibold tracking-widest text-gray-900">FUKUOKA TRIP</span>
          <span class="flex items-center gap-1">
            <span class="inline-block w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
            <span>12/20â€“12/24</span>
          </span>
        </div>

        <!-- æ¨™é¡Œ & æ—¥æœŸåˆ— -->
        <header class="px-5 pt-3 pb-2 bg-gradient-to-b from-[#f7f7f7] to-[#efefef]">
          <h1 class="text-lg font-semibold text-gray-900 tracking-tight">
            ç¦å²¡å®¶æ—æ—…éŠè¡Œç¨‹
          </h1>
          <p class="text-xs text-gray-500 mt-1">
            å·¦å³æ»‘å‹•åˆ‡æ›æ—¥æœŸï¼Œé»è¡Œç¨‹å…ˆçœ‹å…§å®¹ï¼Œå†æ±ºå®šè¦ä¸è¦ç·¨è¼¯æˆ–å°èˆªã€‚
          </p>

          <!-- æ—¥æœŸï¼‹å¤©æ°£ï¼Œæ©«å‘æ»‘å‹• -->
          <div class="mt-3 flex gap-2 overflow-x-auto scrollbar-hide pb-1">
            <button
              v-for="(day, index) in days"
              :key="day.id"
              class="shrink-0 w-32 px-3 py-2 rounded-2xl text-left border transition-all duration-150"
              :class="day.id === selectedDayId
                ? 'bg-[#D5D7E2] text-gray-900 border-gray-900 shadow-md'
                : 'bg-[#E6E6E6] text-gray-700 border-gray-300 hover:border-gray-500'"
              @click="selectDay(day.id)"
            >
              <div class="flex items-center justify-between">
                <span
                  class="text-[12px] uppercase tracking-widest font-semibold text-gray-800"
                >
                  Day {{ index + 1 }}
                </span>
                <span
                  v-if="dayWeathers[index]"
                  class="text-[11px] text-gray-600 flex items-center gap-0.5"
                >
                  <span>{{ weatherEmoji(dayWeathers[index].code) }}</span>
                </span>
              </div>
              <div class="text-[12px] mt-0.5 text-gray-800 font-medium">
                {{ day.dateLabel }}
              </div>
              <div
                v-if="dayWeathers[index]"
                class="mt-1 text-[11px] text-gray-700"
              >
                <span class="font-semibold text-gray-900">
                  {{ Math.round(dayWeathers[index].max) }}Â°
                </span>
                / {{ Math.round(dayWeathers[index].min) }}Â°C
              </div>
              <div v-else class="mt-1 text-[11px] text-gray-500">
                è®€å–å¤©æ°£ä¸­â€¦
              </div>
            </button>
          </div>
        </header>

        <!-- ä¸»å…§å®¹ -->
        <main class="flex-1 flex flex-col gap-2 px-4 pb-4">
          <!-- è¡Œç¨‹åˆ—è¡¨ -->
          <section
            class="flex-1 bg-[#f7f7f7] rounded-2xl px-3 pt-3 pb-2 border border-gray-200 flex flex-col"
          >
            <div class="flex items-center justify-between mb-2">
              <div>
                <h2 class="text-xs font-semibold text-gray-800 tracking-wide">
                  {{ currentDay?.dateLabel || 'é¸æ“‡ä¸€å€‹æ—¥æœŸ' }}
                </h2>
                <p class="text-[10px] text-gray-500 mt-0.5">
                  è¡Œç¨‹å¡ç”¨è«è˜­è¿ªè‰²å¡Šå€åˆ†ï¼›è»Šç¨‹å°ºå¯¸è¼ƒå°ã€é¡è‰²æ›´æ·¡ã€‚
                </p>
              </div>
            </div>

            <div
              v-if="!currentDay || currentDay.items.length === 0"
              class="flex-1 flex flex-col items-center justify-center text-center text-xs text-gray-500"
            >
              <p>ç›®å‰é€™ä¸€å¤©é‚„æ²’æœ‰æ’è¡Œç¨‹ã€‚</p>
            </div>

            <div
              v-else
              class="flex-1 overflow-y-auto scrollbar-hide space-y-2 pr-1"
            >
              <article
                v-for="(item, index) in sortedItems"
                :key="item.id"
                class="relative group rounded-2xl border transition-all duration-150 cursor-pointer flex gap-3"
                :class="[
                  'px-3',
                  item.type === 'stay'
                    ? 'bg-[#E8ECEF] border-[#D6DEE4] py-3 shadow-[0_1px_3px_rgba(0,0,0,0.05)]'
                    : item.type === 'transit'
                    ? 'bg-[#ECEBE7] border-[#DDD9CF] py-2.5'
                    : 'bg-[#F1E7D8] border-[#E0D3C0] py-3 shadow-[0_1px_3px_rgba(0,0,0,0.05)]'
                ]"
                draggable="true"
                @dragstart="onDragStart(index)"
                @dragover.prevent
                @drop="onDrop(index)"
                @click="openPreviewForItem(item)"
              >
                <!-- å·¦å´ç´°è‰²æ¢ -->
                <div
                  class="w-[3px] rounded-full mt-0.5"
                  :class="leftStripClass(item)"
                ></div>

                <!-- å…§å®¹ -->
                <div class="flex-1 flex gap-2">
                  <!-- æ™‚é–“å€å¡Š -->
                  <div class="flex flex-col items-start mr-1 min-w-[96px]">
                    <div
                      :class="item.type === 'transit'
                        ? 'text-[11px] sm:text-xs font-semibold text-gray-900'
                        : 'text-[13px] sm:text-sm font-semibold text-gray-900'"
                    >
                      {{ item.time || 'è‡ªç”±æ´»å‹•' }}
                    </div>
                    <div
                      class="mt-1 inline-flex items-center gap-1 text-[11px] text-gray-700"
                    >
                      <span>{{ typeIcon(item) }}</span>
                      <span>{{ typeLabel(item.type) }}</span>
                    </div>
                  </div>

                  <!-- å³å´æ–‡å­—å…§å®¹ -->
                  <div class="flex-1 min-w-0">
                    <h3
                      class="text-[13px] sm:text-sm font-semibold text-gray-900 truncate"
                    >
                      {{ item.title }}
                    </h3>
                    <p
                      v-if="item.location"
                      class="text-[11px] text-gray-700 mt-0.5 truncate"
                    >
                      ğŸ“ {{ item.location }}
                    </p>
                    <p
                      v-if="item.note"
                      class="text-[11px] text-gray-700 mt-1 line-clamp-2"
                    >
                      å‚™è¨»ï¼š{{ item.note }}
                    </p>
                    <p
                      v-else-if="item.details && item.details.length"
                      class="text-[11px] text-gray-600 mt-1 line-clamp-2"
                    >
                      äº®é»ï¼š
                      <span>{{ item.details.join('ã€') }}</span>
                    </p>
                  </div>
                </div>
              </article>
            </div>

            <!-- æ–°å¢è¡Œç¨‹ -->
            <div class="mt-2">
              <button
                class="w-full flex items-center justify-center gap-1.5 rounded-2xl border border-dashed border-gray-400 text-[11px] text-gray-700 py-2 bg-white hover:bg-gray-100 transition"
                @click="openSheetForCreate"
              >
                <span class="text-base leading-none">ï¼‹</span>
                <span>æ–°å¢è¡Œç¨‹</span>
              </button>
            </div>
          </section>

          <!-- åœ°åœ– -->
          <section
            class="h-40 bg-white rounded-2xl border border-gray-200 overflow-hidden flex flex-col"
          >
            <div class="px-3 pt-2 flex items-center justify-between">
              <div>
                <p class="text-[11px] text-gray-500 uppercase tracking-wide">
                  MAP &amp; NAVIGATION
                </p>
                <p class="text-xs text-gray-900 mt-0.5 truncate">
                  {{ currentLocationTitle }}
                </p>
              </div>
              <button
                v-if="currentLocation"
                class="ml-2 text-[11px] px-2.5 py-1.5 rounded-full bg-[#2563EB] text-white font-semibold shadow hover:bg-[#1D4ED8] transition"
                @click.stop="openInGoogleMaps"
              >
                å°èˆªå‰å¾€
              </button>
            </div>
            <div class="flex-1 mt-1">
              <iframe
                v-if="mapEmbedUrl"
                :src="mapEmbedUrl"
                class="w-full h-full border-0"
                loading="lazy"
                allowfullscreen=""
                referrerpolicy="no-referrer-when-downgrade"
              ></iframe>
              <div
                v-else
                class="w-full h-full flex items-center justify-center text-[11px] text-gray-500"
              >
                é»é¸ä¸Šæ–¹ä»»ä¸€è¡Œç¨‹ï¼Œæ­¤è™•æœƒé¡¯ç¤ºå°æ‡‰åœ°é»åœ°åœ–ã€‚
              </div>
            </div>
          </section>
        </main>

        <!-- Footer -->
        <footer
          class="px-4 pb-3 pt-1 text-[10px] text-gray-500 flex items-center justify-between bg-[#f3f3f3] border-t border-gray-200"
        >
          <span>æ‰€æœ‰ä¿®æ”¹éƒ½æœƒè‡ªå‹•å„²å­˜åœ¨æ­¤è£ç½®ï¼ˆlocalStorageï¼‰ã€‚</span>
        </footer>

        <!-- Bottom sheetï¼šè¡Œç¨‹é è¦½ï¼ˆéç·¨è¼¯ï¼‰ -->
        <transition name="sheet">
          <div
            v-if="previewVisible && currentItem"
            class="absolute inset-0 bg-black/30 flex items-end z-30"
            @click.self="closePreview"
          >
            <div
              class="w-full bg-white rounded-t-3xl border-t border-gray-200 px-4 pt-3 pb-4 max-h-[80%] overflow-y-auto"
            >
              <div class="flex items-center justify-between mb-2">
                <div>
                  <div class="text-[11px] text-gray-500">
                    {{ currentDay?.dateLabel }}
                  </div>
                  <div class="text-[15px] font-semibold text-gray-900 mt-1">
                    {{ currentItem.time }}
                  </div>
                </div>
                <button
                  class="text-xs text-gray-500 hover:text-gray-900"
                  @click="closePreview"
                >
                  é—œé–‰
                </button>
              </div>

              <div class="mb-2">
                <h3 class="text-sm font-semibold text-gray-900">
                  {{ currentItem.title }}
                </h3>
                <p
                  v-if="currentItem.location"
                  class="text-[11px] text-gray-700 mt-0.5"
                >
                  ğŸ“ {{ currentItem.location }}
                </p>
              </div>

              <div v-if="currentItem.note" class="mb-2">
                <h4 class="text-[11px] font-semibold text-gray-700 mb-0.5">
                  å‚™è¨»
                </h4>
                <p class="text-[11px] text-gray-700 whitespace-pre-line">
                  {{ currentItem.note }}
                </p>
              </div>

              <div v-if="currentItem.details && currentItem.details.length" class="mb-2">
                <h4 class="text-[11px] font-semibold text-gray-700 mb-0.5">
                  äº®é» / å¿…ç©
                </h4>
                <ul class="text-[11px] text-gray-700 list-disc pl-4 space-y-0.5">
                  <li v-for="(d, idx) in currentItem.details" :key="idx">
                    {{ d }}
                  </li>
                </ul>
              </div>

              <div class="pt-2 flex gap-2">
                <button
                  type="button"
                  class="flex-1 rounded-2xl bg-[#2563EB] text-white text-xs font-semibold py-2.5 shadow hover:bg-[#1D4ED8] transition"
                  @click="openInGoogleMaps"
                >
                  å°èˆªå‰å¾€
                </button>
                <button
                  type="button"
                  class="w-24 rounded-2xl bg-gray-100 text-gray-800 text-xs font-semibold py-2.5 border border-gray-300 hover:bg-gray-200 transition"
                  @click="openSheetFromPreview"
                >
                  ç·¨è¼¯
                </button>
              </div>
            </div>
          </div>
        </transition>

        <!-- Bottom sheetï¼šè¡Œç¨‹ç·¨è¼¯ -->
        <transition name="sheet">
          <div
            v-if="sheetVisible"
            class="absolute inset-0 bg-black/30 flex items-end z-20"
            @click.self="closeSheet"
          >
            <div
              class="w-full bg-white rounded-t-3xl border-t border-gray-200 px-4 pt-3 pb-4 max-h-[80%] overflow-y-auto"
            >
              <div class="flex items-center justify-between mb-2">
                <h3 class="text-sm font-semibold text-gray-900">
                  {{ isCreating ? 'æ–°å¢è¡Œç¨‹' : 'ç·¨è¼¯è¡Œç¨‹' }}
                </h3>
                <button
                  class="text-xs text-gray-500 hover:text-gray-900"
                  @click="closeSheet"
                >
                  é—œé–‰
                </button>
              </div>

              <form @submit.prevent="saveItem" class="space-y-3">
                <div class="flex gap-3">
                  <div class="w-32">
                    <label class="block text-[11px] text-gray-500 mb-1"
                      >æ™‚é–“ï¼ˆå¿…å¡«ï¼‰</label
                    >
                    <input
                      v-model="editingItem.time"
                      type="text"
                      placeholder="ä¾‹å¦‚ 10:00â€“14:00"
                      class="w-full rounded-xl border border-gray-300 text-xs text-gray-900 px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-gray-900 focus:border-gray-900"
                      required
                    />
                  </div>
                  <div class="flex-1">
                    <label class="block text-[11px] text-gray-500 mb-1"
                      >è¡Œç¨‹æ¨™é¡Œ</label
                    >
                    <input
                      v-model="editingItem.title"
                      type="text"
                      placeholder="ä¾‹å¦‚ æµ·ä¹‹ä¸­é“æµ·æ´‹ä¸–ç•Œ"
                      class="w-full rounded-xl border border-gray-300 text-xs text-gray-900 px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-gray-900 focus:border-gray-900"
                      required
                    />
                  </div>
                </div>

                <div>
                  <label class="block text-[11px] text-gray-500 mb-1"
                    >åœ°é»ï¼ˆç”¨æ–¼åœ°åœ–èˆ‡å°èˆªï¼‰</label
                  >
                  <input
                    v-model="editingItem.location"
                    type="text"
                    placeholder="ä¾‹å¦‚ åšå¤šç«™, Fukuoka æˆ–å®Œæ•´åœ°å€"
                    class="w-full rounded-xl border border-gray-300 text-xs text-gray-900 px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-gray-900 focus:border-gray-900"
                  />
                </div>

                <div class="flex gap-2">
                  <div class="flex-1">
                    <label class="block text-[11px] text-gray-500 mb-1"
                      >é¡å‹</label
                    >
                    <select
                      v-model="editingItem.type"
                      class="w-full rounded-xl border border-gray-300 text-xs text-gray-900 px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-gray-900 focus:border-gray-900"
                    >
                      <option value="stay">åœç•™</option>
                      <option value="transit">è»Šç¨‹</option>
                      <option value="flight">é£›æ©Ÿ</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label class="block text-[11px] text-gray-500 mb-1"
                    >å‚™è¨»ï¼ˆç°¡çŸ­æé†’ï¼‰</label
                  >
                  <textarea
                    v-model="editingItem.note"
                    rows="2"
                    placeholder="ä¾‹å¦‚ï¼šè¨˜å¾—å¹«å°å­©æ›å°¿å¸ƒã€å®‰æ’å°ç¡æ™‚é–“ç­‰"
                    class="w-full rounded-xl border border-gray-300 text-xs text-gray-900 px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-gray-900 focus:border-gray-900 resize-none"
                  ></textarea>
                </div>

                <div>
                  <label class="block text-[11px] text-gray-500 mb-1"
                    >äº®é» / å¿…ç©ç´°ç¯€ï¼ˆæ¯è¡Œä¸€é»ï¼‰</label
                  >
                  <textarea
                    v-model="editingDetailsText"
                    rows="3"
                    placeholder="ä¾‹å¦‚ï¼š&#10;ãƒ»10:50 æµ·è±¹ Go Go Seal&#10;ãƒ»11:00 æµ·è±šè¡¨æ¼”"
                    class="w-full rounded-xl border border-gray-300 text-xs text-gray-900 px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-gray-900 focus:border-gray-900 resize-none"
                  ></textarea>
                </div>

                <div class="pt-1 flex gap-2">
                  <button
                    type="submit"
                    class="flex-1 rounded-2xl bg-gray-900 text-white text-xs font-semibold py-2.5 hover:bg-black transition"
                  >
                    å„²å­˜
                  </button>
                  <button
                    v-if="!isCreating"
                    type="button"
                    class="w-20 rounded-2xl bg-red-50 text-red-600 text-xs font-semibold py-2.5 border border-red-200 hover:bg-red-100 transition"
                    @click="deleteItem"
                  >
                    åˆªé™¤
                  </button>
                </div>
              </form>
            </div>
          </div>
        </transition>
      </div>
    </div>

    <script>
      const { createApp, computed, watch } = Vue;

      createApp({
        data() {
          return {
            days: [],
            selectedDayId: 1,
            selectedItemId: null,

            // é è¦½æµ®å±¤
            previewVisible: false,

            // ç·¨è¼¯æµ®å±¤
            sheetVisible: false,
            isCreating: false,
            editingItem: {
              id: null,
              type: 'stay',
              time: '',
              title: '',
              location: '',
              note: '',
              details: []
            },
            editingDetailsText: '',

            dayWeathers: [],
            dragSourceIndex: null
          };
        },
        computed: {
          currentDay() {
            return this.days.find((d) => d.id === this.selectedDayId) || null;
          },
          sortedItems() {
            if (!this.currentDay) return [];
            return [...this.currentDay.items].sort((a, b) => {
              const at = /^\d/.test(a.time || '') ? a.time : 'ZZZ';
              const bt = /^\d/.test(b.time || '') ? b.time : 'ZZZ';
              return at.localeCompare(bt);
            });
          },
          currentItem() {
            if (!this.currentDay || !this.selectedItemId) return null;
            return this.currentDay.items.find((i) => i.id === this.selectedItemId) || null;
          },
          currentLocation() {
            return this.currentItem && this.currentItem.location
              ? this.currentItem.location
              : '';
          },
          currentLocationTitle() {
            if (!this.currentItem) return 'å°šæœªé¸æ“‡è¡Œç¨‹';
            return this.currentItem.title || 'è¡Œç¨‹';
          },
          mapEmbedUrl() {
            if (!this.currentLocation) return '';
            const q = encodeURIComponent(this.currentLocation);
            return `https://www.google.com/maps?q=${q}&output=embed`;
          }
        },
        methods: {
          // === åˆå§‹åŒ–é è¨­è¡Œç¨‹ ===
          initDefaultDays() {
            this.days = [
              {
                id: 1,
                dateLabel: '12/20ï¼ˆäº”ï¼‰',
                items: [
                  {
                    id: 101,
                    type: 'flight',
                    time: '08:00â€“11:15',
                    title: 'é•·æ¦® BR106 æŠµé”ç¦å²¡',
                    location: 'Fukuoka Airport',
                    note: 'å…¥å¢ƒã€å–è¡Œæ',
                    details: []
                  },
                  {
                    id: 102,
                    type: 'stay',
                    time: '12:00â€“13:30',
                    title: 'åšå¤šç”ºå±‹ãƒ»æ«›ç”°ç¥ç¤¾',
                    location: 'Kushida Shrine Fukuoka',
                    note: '',
                    details: ['åƒè§€è€è¡—', 'ç¥‡åœ’å±±ç¬ æ­·å²é¤¨']
                  },
                  {
                    id: 103,
                    type: 'transit',
                    time: '13:40â€“14:00',
                    title: 'æ«›ç”°ç¥ç¤¾ â†’ Blossom Hotel',
                    location:
                      'Kushida Shrine â†’ JR Kyushu Hotel Blossom Hakata Central',
                    note: '',
                    details: []
                  },
                  {
                    id: 104,
                    type: 'stay',
                    time: '14:00â€“16:30',
                    title: 'JR ä¹å· Blossom é£¯åº— Check-in',
                    location: 'JR Kyushu Hotel Blossom Hakata Central',
                    note: '',
                    details: ['å¯„æ”¾è¡Œæ', 'é™„è¿‘é¤å»³æ–¹ä¾¿è¦“é£Ÿ']
                  },
                  {
                    id: 105,
                    type: 'stay',
                    time: '16:30â€“20:00',
                    title: 'åšå¤šé‹æ²³åŸ',
                    location: 'Canal City Hakata',
                    note: '',
                    details: ['è‡ªç”±æ´»å‹•']
                  }
                ]
              },
              {
                id: 2,
                dateLabel: '12/21ï¼ˆå…­ï¼‰',
                items: [
                  {
                    id: 201,
                    type: 'transit',
                    time: '09:30â€“10:00',
                    title: 'å‰å¾€æµ·ä¹‹ä¸­é“æµ·æ´‹ä¸–ç•Œ Marine World',
                    location: 'Hakata Station â†’ Marine World Uminonakamichi',
                    note: '',
                    details: []
                  },
                  {
                    id: 202,
                    type: 'stay',
                    time: '10:00â€“14:00',
                    title: 'æµ·ä¹‹ä¸­é“æµ·æ´‹ä¸–ç•Œ Marine World',
                    location: 'Marine World Uminonakamichi',
                    note: 'æå‰ 10 åˆ†é˜å¡ä½ã€å‹•ç·šç·Šå¯†',
                    details: [
                      '10:50 æµ·è±¹ Go Go Seal',
                      '11:00 æµ·è±šè¡¨æ¼”',
                      '12:45 ä¼éµéŠè¡Œ',
                      '12:00â€“13:00 Reilly æµ·æ™¯é¤å»³åˆé¤'
                    ]
                  },
                  {
                    id: 203,
                    type: 'transit',
                    time: '14:00â€“14:30',
                    title: 'æµ·æ´‹ä¸–ç•Œ â†’ å¤©ç¥ Parco',
                    location: 'Marine World â†’ Tenjin Parco',
                    note: '',
                    details: []
                  },
                  {
                    id: 204,
                    type: 'stay',
                    time: '14:30â€“20:00',
                    title: 'å¤©ç¥è¡—å€è‡ªç”±æ´»å‹•',
                    location: 'Tenjin area, Fukuoka',
                    note: '',
                    details: ['è³¼ç‰©', 'è—¥å¦', 'ç¾å¦', 'å’–å•¡ä¼‘æ¯']
                  },
                  {
                    id: 205,
                    type: 'transit',
                    time: '20:00â€“20:30',
                    title: 'å¤©ç¥ â†’ Blossom é£¯åº—',
                    location:
                      'Tenjin â†’ JR Kyushu Hotel Blossom Hakata Central',
                    note: '',
                    details: []
                  }
                ]
              },
              {
                id: 3,
                dateLabel: '12/22ï¼ˆæ—¥ï¼‰',
                items: [
                  {
                    id: 301,
                    type: 'stay',
                    time: '08:00â€“08:30',
                    title: 'é£¯åº— Check-out',
                    location: 'JR Kyushu Hotel Blossom Hakata Central',
                    note: '',
                    details: []
                  },
                  {
                    id: 302,
                    type: 'transit',
                    time: '08:30â€“10:30',
                    title: 'åšå¤š â†’ ä¹å·è‡ªç„¶å‹•ç‰©åœ’',
                    location: 'Hakata â†’ African Safari Oita',
                    note: 'è»Šç¨‹ç´„ 2 å°æ™‚',
                    details: []
                  },
                  {
                    id: 303,
                    type: 'stay',
                    time: '10:30â€“13:30',
                    title: 'ä¹å·è‡ªç„¶å‹•ç‰©åœ’ï¼ˆAfrican Safariï¼‰',
                    location: 'African Safari Oita',
                    note: '',
                    details: [
                      '11:00 å¢æ—å·´å£«ï¼ˆ50 åˆ†ï¼‰',
                      '12:00â€“13:00 åœ’å…§é¤å»³åˆé¤',
                      'å‹•ç‰©åœ’æ•£æ­¥æ‹ç…§ã€è¦ªå­é«”é©—'
                    ]
                  },
                  {
                    id: 304,
                    type: 'transit',
                    time: '13:30â€“14:00',
                    title: 'å‹•ç‰©åœ’ â†’ æ¹¯å¸ƒé™¢æ˜­å’Œé¤¨',
                    location: 'African Safari â†’ Yufuin Showa Museum',
                    note: '',
                    details: []
                  },
                  {
                    id: 305,
                    type: 'stay',
                    time: '14:00â€“17:30',
                    title: 'æ¹¯ã®åªè¡—é“æ•£ç­–ï¼ˆæ¹¯å¸ƒé™¢ï¼‰',
                    location: 'Yunotsubo Kaido, Yufuin',
                    note: '',
                    details: ['èŠ±å‰æ‘', 'æ¹¯ã®åªæ¨ªä¸', 'Snoopy ä¸»é¡Œå•†åº—']
                  },
                  {
                    id: 306,
                    type: 'transit',
                    time: '17:30â€“18:00',
                    title: 'æ¹¯å¸ƒé™¢ â†’ åˆ¥åºœ',
                    location: 'Yufuin â†’ Beppu',
                    note: '',
                    details: []
                  },
                  {
                    id: 307,
                    type: 'stay',
                    time: '18:00â€“21:00',
                    title: 'Check-in è¥¿éµ Resort Inn åˆ¥åºœ',
                    location: 'Nishitetsu Resort Inn Beppu',
                    note: '',
                    details: ['é£¯åº—å‘¨é‚Šè‡ªç”±æ´»å‹•', 'ç”¨é¤']
                  }
                ]
              },
              {
                id: 4,
                dateLabel: '12/23ï¼ˆä¸€ï¼‰',
                items: [
                  {
                    id: 401,
                    type: 'stay',
                    time: '10:00â€“10:10',
                    title: 'è¥¿éµ Resort Inn åˆ¥åºœ Check-out',
                    location: 'Nishitetsu Resort Inn Beppu',
                    note: '',
                    details: []
                  },
                  {
                    id: 402,
                    type: 'transit',
                    time: '10:10â€“12:10',
                    title: 'åˆ¥åºœ â†’ å¤ªå®°åºœå¤©æ»¿å®®',
                    location: 'Beppu â†’ Dazaifu Tenmangu',
                    note: '',
                    details: []
                  },
                  {
                    id: 403,
                    type: 'stay',
                    time: '12:10â€“13:30',
                    title: 'å¤ªå®°åºœå¤©æ»¿å®® + åƒé“å•†åº—è¡—',
                    location: 'Dazaifu Tenmangu',
                    note: '',
                    details: ['æ¢…æé¤…', 'å¾¡å®ˆ', 'å¯æ„›å°åº—']
                  },
                  {
                    id: 404,
                    type: 'stay',
                    time: '13:30â€“14:30',
                    title: 'å¤ªå®°åºœå‘¨é‚Šåˆé¤',
                    location: 'Dazaifu restaurants',
                    note: '',
                    details: []
                  },
                  {
                    id: 405,
                    type: 'stay',
                    time: '14:30â€“16:30',
                    title: 'ä¹å·åœ‹ç«‹åšç‰©é¤¨ï¼ˆæˆ–å¸‚å€è‡ªç”±æ´»å‹•ï¼‰',
                    location: 'Kyushu National Museum',
                    note: '',
                    details: []
                  },
                  {
                    id: 406,
                    type: 'transit',
                    time: '17:00â€“18:00',
                    title: 'å¤ªå®°åºœ â†’ ç¦å²¡å¤©ç¥æ˜†ç‰¹è–©é…’åº—',
                    location: 'Dazaifu â†’ Quintessa Hotel Fukuoka Tenjin',
                    note: '',
                    details: []
                  },
                  {
                    id: 407,
                    type: 'stay',
                    time: '18:00â€“19:00',
                    title: 'Check-in + æ•´ç†ä¼‘æ¯',
                    location: 'Quintessa Hotel Fukuoka Tenjin',
                    note: '',
                    details: []
                  },
                  {
                    id: 408,
                    type: 'stay',
                    time: '19:00â€“21:00',
                    title: 'ç¦å²¡å¡”',
                    location: 'Fukuoka Tower',
                    note: '',
                    details: ['å¤•é™½', 'å¤œæ™¯', 'å¡”ä¸‹æµ·æ¿±æ•£æ­¥']
                  }
                ]
              },
              {
                id: 5,
                dateLabel: '12/24ï¼ˆäºŒï¼‰',
                items: [
                  {
                    id: 501,
                    type: 'stay',
                    time: '11:00â€“11:10',
                    title: 'ç¦å²¡å¤©ç¥æ˜†ç‰¹è–©é…’åº— Check-out',
                    location: 'Quintessa Hotel Fukuoka Tenjin',
                    note: '',
                    details: []
                  },
                  {
                    id: 502,
                    type: 'transit',
                    time: '11:10â€“11:20',
                    title: 'é£¯åº— â†’ éºµåŒ…è¶…äººåšç‰©é¤¨',
                    location:
                      "Quintessa Hotel â†’ Anpanman Children's Museum in Fukuoka",
                    note: '',
                    details: []
                  },
                  {
                    id: 503,
                    type: 'stay',
                    time: '11:20â€“12:30',
                    title: 'éºµåŒ…è¶…äººåšç‰©é¤¨',
                    location: "Anpanman Children's Museum in Fukuoka",
                    note: '',
                    details: ['å®¤å…§éŠå…·', 'æ‹ç…§é»', 'å‘¨é‚Šå•†å“']
                  },
                  {
                    id: 504,
                    type: 'transit',
                    time: '12:30â€“12:50',
                    title: 'éºµåŒ…è¶…äºº â†’ åšå¤šé˜ªæ€¥',
                    location: 'Anpanman Museum â†’ Hakata Hankyu',
                    note: '',
                    details: []
                  },
                  {
                    id: 505,
                    type: 'stay',
                    time: '12:50â€“17:30',
                    title: 'åšå¤šé˜ªæ€¥ï¼ˆåˆé¤ + è³¼ç‰©ï¼‰',
                    location: 'Hakata Hankyu Fukuoka',
                    note: '',
                    details: ['Dacomecca', 'ç™¾è²¨ç¾é£Ÿæ¨“', 'æœ€å¾Œæ¡è²·']
                  },
                  {
                    id: 506,
                    type: 'transit',
                    time: '17:30â€“18:00',
                    title: 'åšå¤šé˜ªæ€¥ â†’ ç¦å²¡æ©Ÿå ´',
                    location: 'Hakata Hankyu â†’ Fukuoka Airport',
                    note: '',
                    details: []
                  },
                  {
                    id: 507,
                    type: 'stay',
                    time: '18:00â€“20:55',
                    title: 'ç¦å²¡æ©Ÿå ´ï¼ˆæ‰˜é‹ã€å…ç¨…åº—ã€ä¼‘æ¯ï¼‰',
                    location: 'Fukuoka Airport',
                    note: '',
                    details: []
                  },
                  {
                    id: 508,
                    type: 'flight',
                    time: '20:55â€“22:40',
                    title: 'é•·æ¦® BR101 å›ç¨‹',
                    location: 'Fukuoka Airport',
                    note: '',
                    details: []
                  }
                ]
              }
            ];
          },

          loadFromStorage() {
            try {
              const raw = localStorage.getItem('fukuokaTripAppV4');
              if (raw) {
                const data = JSON.parse(raw);
                if (data.days && Array.isArray(data.days) && data.days.length > 0) {
                  this.days = data.days;
                  this.selectedDayId = data.selectedDayId || 1;
                  this.selectedItemId = data.selectedItemId || null;
                  return;
                }
              }
            } catch (e) {
              console.warn('è®€å–æœ¬åœ°è¡Œç¨‹å¤±æ•—ï¼Œä½¿ç”¨é è¨­è¡Œç¨‹', e);
            }
            this.initDefaultDays();
          },

          saveToStorage() {
            const payload = {
              days: this.days,
              selectedDayId: this.selectedDayId,
              selectedItemId: this.selectedItemId
            };
            localStorage.setItem('fukuokaTripAppV4', JSON.stringify(payload));
          },

          // UI
          selectDay(id) {
            this.selectedDayId = id;
            const day = this.currentDay;
            this.selectedItemId = day?.items[0]?.id || null;
            this.previewVisible = false;
          },

          openPreviewForItem(item) {
            this.selectedItemId = item.id;
            this.previewVisible = true;
          },

          closePreview() {
            this.previewVisible = false;
          },

          openSheetFromPreview() {
            if (!this.currentItem) return;
            this.openSheetForEdit(this.currentItem);
            this.previewVisible = false;
          },

          openSheetForEdit(item) {
            this.isCreating = false;
            this.sheetVisible = true;
            this.editingItem = JSON.parse(JSON.stringify(item));
            this.editingDetailsText = (item.details || []).join('\n');
            this.selectedItemId = item.id;
          },

          openSheetForCreate() {
            this.isCreating = true;
            this.sheetVisible = true;
            this.previewVisible = false;
            this.editingItem = {
              id: null,
              type: 'stay',
              time: '',
              title: '',
              location: '',
              note: '',
              details: []
            };
            this.editingDetailsText = '';
          },

          closeSheet() {
            this.sheetVisible = false;
          },

          saveItem() {
            if (!this.currentDay) return;

            const detailsLines = this.editingDetailsText
              .split('\n')
              .map((s) => s.replace(/^ãƒ»/, '').trim())
              .filter((s) => s.length > 0);

            this.editingItem.details = detailsLines;

            if (this.isCreating) {
              const allIds = this.days.flatMap((d) => d.items.map((i) => i.id));
              const newId = (allIds.reduce((m, v) => Math.max(m, v), 0) || 0) + 1;
              this.editingItem.id = newId;
              this.currentDay.items.push(JSON.parse(JSON.stringify(this.editingItem)));
              this.selectedItemId = newId;
            } else {
              const idx = this.currentDay.items.findIndex(
                (i) => i.id === this.editingItem.id
              );
              if (idx !== -1) {
                this.currentDay.items[idx] = JSON.parse(
                  JSON.stringify(this.editingItem)
                );
                this.selectedItemId = this.editingItem.id;
              }
            }

            this.closeSheet();
            this.saveToStorage();
          },

          deleteItem() {
            if (!this.currentDay || this.isCreating) return;
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹è¡Œç¨‹å—ï¼Ÿ')) return;
            const id = this.editingItem.id;
            this.currentDay.items = this.currentDay.items.filter((i) => i.id !== id);
            if (this.selectedItemId === id) {
              this.selectedItemId = this.currentDay.items[0]?.id || null;
            }
            this.closeSheet();
            this.saveToStorage();
          },

          openInGoogleMaps() {
            if (!this.currentLocation) return;
            const dest = encodeURIComponent(this.currentLocation);
            window.open(
              `https://www.google.com/maps/dir/?api=1&destination=${dest}`,
              '_blank'
            );
          },

          typeLabel(type) {
            if (type === 'transit') return 'è»Šç¨‹';
            if (type === 'flight') return 'é£›æ©Ÿ';
            return 'åœç•™';
          },

          typeIcon(item) {
            if (item.type === 'flight') return 'âœˆï¸';
            if (item.type === 'transit') return 'ğŸš—';
            return 'ğŸ“';
          },

          leftStripClass(item) {
            if (item.type === 'flight') return 'bg-[#E0D3C0]';
            if (item.type === 'transit') return 'bg-[#D3D0C8]';
            return 'bg-[#C4D4D2]';
          },

          weatherEmoji(code) {
            if (code === undefined || code === null) return 'â€¦';
            if (code === 0) return 'â˜€ï¸';
            if ([1, 2, 3].includes(code)) return 'â›…ï¸';
            if ([45, 48].includes(code)) return 'ğŸŒ«';
            if ([51, 53, 55, 61, 63, 65, 80, 81, 82].includes(code)) return 'ğŸŒ§';
            if ([71, 73, 75, 85, 86].includes(code)) return 'â„ï¸';
            if ([95, 96, 99].includes(code)) return 'â›ˆ';
            return 'ğŸŒ¤';
          },

          async fetchWeather() {
            try {
              const today = new Date();
              const toISO = (d) => d.toISOString().slice(0, 10);
              const start = toISO(today);
              const endDate = new Date(
                today.getTime() + (this.days.length - 1) * 24 * 60 * 60 * 1000
              );
              const end = toISO(endDate);

              const url =
                'https://api.open-meteo.com/v1/forecast?' +
                'latitude=33.5902&longitude=130.4017&timezone=Asia%2FTokyo' +
                '&daily=temperature_2m_max,temperature_2m_min,weathercode' +
                `&start_date=${start}&end_date=${end}`;

              const res = await fetch(url);
              const data = await res.json();
              const daily = data.daily;

              this.dayWeathers = daily.time.map((_, idx) => ({
                max: daily.temperature_2m_max[idx],
                min: daily.temperature_2m_min[idx],
                code: daily.weathercode[idx]
              }));
            } catch (e) {
              console.error('ç„¡æ³•å–å¾—å¤©æ°£è³‡æ–™', e);
            }
          },

          // æ‹–æ›³æ’åº
          onDragStart(index) {
            this.dragSourceIndex = index;
          },
          onDrop(targetIndex) {
            if (this.dragSourceIndex === null || this.dragSourceIndex === targetIndex)
              return;
            const list = this.currentDay.items;
            const moved = list.splice(this.dragSourceIndex, 1)[0];
            list.splice(targetIndex, 0, moved);
            this.dragSourceIndex = null;
            this.saveToStorage();
          }
        },
        mounted() {
          this.loadFromStorage();
          if (this.currentDay && this.currentDay.items.length > 0) {
            this.selectedItemId = this.currentDay.items[0].id;
          }
          this.fetchWeather();
        },
        watch: {
          days: {
            deep: true,
            handler() {
              this.saveToStorage();
            }
          },
          selectedDayId() {
            this.saveToStorage();
          },
          selectedItemId() {
            this.saveToStorage();
          }
        }
      }).mount('#app');
    </script>
  </body>
</html>
